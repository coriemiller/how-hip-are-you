<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>How Hip Are You?</title>
<!--     <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
 -->    
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">



    <style type="text/css">
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      /* Margin bottom by footer height */
      margin-bottom: 30px;
      color: #4d4d4d;
      font-family: 'Roboto Slab', sans-serif;
    }
    .caption {
        position: absolute;
        top: 30%;
        left: 0;
        width: 100%;
        color: white !important;
    }
    .thumbnail {
        position: relative;
        border: none;
    }
      #login, #loggedin {
        display: none;
      }
      #login {
        margin-top: 18%;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }

      .img-circle {
          border-radius: 50%;
          opacity: .8;
      }
      .media {
        margin-bottom: 25px;
      }
      .media-body {
        margin-top: 15px;
        margin-bottom: 15px;
      }
      #login-button {
        margin-top: 30px;
        max-width: 200px;
      }

      table {
        outline: 1px solid #666;   
        width: 100%;
      }
      h1 {
        font-size: 50px;
      }
      h1, .hip, h2 {
          text-align: center;    
        }

      th {
        background: #f8f8f8; 
        font-weight: bold;    
        padding: 2px;
      }
      td {
        padding: 2px;
        vertical-align: middle;
      }
      tr {
        padding:8px;
        vertical-align: middle;
      }
      .countdown {
        font-size: 60px;
      }
      #footnote{
        font-size: 14px;
        font-style: italic;
        margin: 20px 0;
      }
      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        /* Set the fixed height of the footer here */
        height: 30px;
        background-color: #f5f5f5;
      }
      .text-muted {
        text-align: center;
      }

      .container-footer {
        width: auto;
        padding: 0 15px;
      }
      .container-footer .text-muted {
        margin: 5px 0;
      }

        .clear:before,
        .clear:after {
            content: "";
            display: table;
        }

        .clear:after {
            clear: both;
        }

        .clear {
            *zoom: 1;
        }

    #hip-gauge {
        display: block;
        box-sizing: border-box;
        margin: auto;
        margin-bottom: 30px;
        width: 85%;

    }
    .h-split {
        display: block;
        float: left;
        width: 1%;
        min-height: 100px;
    }
    

    .below {
    position: absolute;
    top:100%;
    }

    #jgDownload text:nth-child(8) tspan,jgDownload text:nth-child(9) tspan,jgDownload text:nth-child(10) tspan {
    font-size: 0.9em !important; 
    font-family: 'Oswald', sans-serif;
  }

    </style>
  </head>

  <body>
    <div class="container">
      <div id="login">
        <h1>How hip are you?</h1>
        <a href="/login" id="login-button" class="btn btn-primary centered center-block">Log in with Spotify</a>
      </div>
      <div id="loggedin">

        <div id="user-profile">
        </div>

          <div id="hip-gauge">
          </div>
          <div class="clear"></div>


      <div class="table-responsive" style="display:none">
        <table id="artist-info-table" class="table">
          <h1 id="table-title" style="display:none">Your Top Artists</h1>
            <tr>
                <th></th>
                <th>Artist</th>
                <th>Rank</th>
                <th>Hipscore</th>
                <th>Followers</th>
                <th>Genres</th>
            </tr>
        </table>
      </div>
      <div id="footnote" style="display:none">
        Spotify assigns a relative popularity value to artists ranging from 0 - 100. The hipscore is 100 minus the Spotify popularity value. Your hipscore is the average hipscore of your top 20 artists. The higher your hipscore is, the more hip you are. Go turn off that Drake you basic bitch and <i>get hip</i>.
      </div>
      </div>

        <div id="oauth">
        </div>
        <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>


    </div>

    <footer class="footer" style="display:none">
      <div class="container-footer">
        <p class="text-muted"></p>
      </div>
    </footer>


    <script id="user-profile-template" type="text/x-handlebars-template">
      <div class="media">
        <div class="media-body">
            <h1>Think you're hip, {{display_name}}? Let's find out.</h1>
        </div>
        <div class="thumbnail text-center">
          <img class="media-object img-circle centered center-block mt-3 mb-3 hipswap" width="300" src="{{images.0.url}}"/>
          <div class="caption">
            <div class="countdown">3</div>
          </div>
        </div>
      </div>

    </script>


    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/raphael-2.1.4.min.js"></script>
    <script src="js/justgage.js"></script>

    <script>
      (function() {
                  $('#oauth').hide();
                  $('#obtain-new-token').hide();

        // var stateKey = 'spotify_auth_state';

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        /**
         * Generates a random string containing numbers and letters
         * @param  {number} length The length of the string
         * @return {string} The generated string
         */
        function generateRandomString(length) {
          var text = '';
          var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

          for (var i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
          }
          return text;
        };

        function titleCase(str) {
             str = str.toLowerCase().split(' ');                // will split the string delimited by space into an array of words

             for(var i = 0; i < str.length; i++){               // str.length holds the number of occurrences of the array...
                  str[i] = str[i].split('');                    // splits the array occurrence into an array of letters
                  str[i][0] = str[i][0].toUpperCase();          // converts the first occurrence of the array to uppercase
                  str[i] = str[i].join('');                     // converts the array of letters back into a word.
             }
             return str.join(' ');                              //  converts the array of words back to a sentence.
        }

//creates table with user's top artists, creates hipscore meter
        function drawTable(data) {
          for (var i = 0; i < data.length; i++) {
            var tcounter = 0;
            popularitySum += parseInt(data[i].popularity);
            followersSum += parseInt(data[i].followers.total);
            tcounter = i + 1;
            drawRow(data[i], tcounter);
          }
          popularityAvg = 100 - (popularitySum / data.length);
          $(".media-body h1").text("Your hipscore is " + popularityAvg + "!");



        var g = new JustGage({
                id: "hip-gauge",
                value: popularityAvg,
                valueFontColor: "#4d4d4d",
                min: 0,
                minTxt: "Basic",
                max: 100,
                maxTxt: "Hipster",
                label: "",
                gaugeWidthScale: 0.2,
                relativeGaugeSize: true,
                valueFontFamily: "Roboto Slab",
                levelColors: [
                  "#fa4133",
                  "#fdbe37",
                  "#1cb42f"
                ],
                pointer: true,
                pointerOptions: {
                  color: '#696969'
                },
                decimals: 2,
                counter: true,
                noGradient: false,
                labelFontColor: "#696969",
                valueFontColor: "#696969",
                minLabelMinFontSize: 11,
                maxLabelMinFontSize: 11,
                valueMinFontSize: 14,
                customSectors: {
                ranges: [{
                  color : "#fa4133",
                  lo : 0,
                  hi : 33
                },{
                  color : "#fdbe37",
                  lo : 34,
                  hi : 67
                },{
                  color : "#1cb42f",
                  lo : 68,
                  hi : 100
                }]
              }
              });

        }


        function drawRow(rowData, counter) {
            var rawHipscore = 100 - parseInt(rowData.popularity);
            var genresClean = rowData.genres.toString().replace(/,/g , ", ");
            // var titlegenres = titleCase(genresClean).replace(/\&b/g, "&B");
            var followersCommas = rowData.followers.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            var row = $("<tr />")
            $("#artist-info-table").append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
            row.append($('<td> <img class="media-object" width="50" src="' + rowData.images[0].url + '"/></td>'));
            row.append($("<td>" + rowData.name + "</td>"));
            row.append($("<td>" + counter + "</td>"));
            row.append($("<td>" + rawHipscore+ "</td>"));
            row.append($("<td>" + followersCommas + "</td>"));
            row.append($("<td>" + genresClean + "</td>"));
        }

        var popularityAvg = 0,
            popularitySum = 0,
            followersSum = 0;


        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');


            oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();

        // var access_token = params.access_token,
        //     state = params.state,
        //     storedState = localStorage.getItem(stateKey);

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        
        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            // render oauth info
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                  $('#login').hide();
                  $('#loggedin').show();
                }
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me/top/artists',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {

                //countdown
                var hipMeter = document.getElementsByClassName("thumbnail");
                var counter = 3;
                hipMeter.innerHTML = "3";
                var id;
                id = setInterval(function() {
                    counter--;
                    if(counter < 0) {
                        $(hipMeter).hide();
                        //make meter, table
                        $(".table-responsive").removeAttr("style");
                        drawTable(response.items);
                        $("#table-title").removeAttr("style");
                        $("#footnote").removeAttr("style");
                        $("footer").removeAttr("style");
                        $("tspan").css("font-family", "Roboto Slab");
                        clearInterval(id);
                    } else if (counter == 0) {
                      $(".caption div").text("Hip!");
                    } else {
                        $(".caption div").text(counter.toString());
                    }
                }, 1000);
                }
            });
            

          } else {
              $('#login').show();
              $('#loggedin').hide();
          }

            document.getElementById('obtain-new-token').addEventListener('click', function() {
            $.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
              oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
              });
            });
          }, false);

        }
      })();
    $(".text-muted").text("Made by Corie | " + new Date().getFullYear());

    </script>
</html>
